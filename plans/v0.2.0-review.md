# GIMBAL v0.2.0 Repository Restructuring Plan — Review

**Date:** November 29, 2025  
**Reviewer:** GitHub Copilot  
**Document Reviewed:** `v0.2.0_detailed_plan.md`  
**Context:** Pre-implementation review for non-algorithmic restructuring phase  
**Status:** APPROVED WITH MINOR CLARIFICATIONS

---

## Executive Summary

**Recommendation: PROCEED TO IMPLEMENTATION**

The v0.2.0 restructuring plan is **well-conceived, appropriately scoped, and implementation-ready**. This non-algorithmic phase correctly prioritizes structural improvements that will significantly reduce friction for the v0.2.1–0.2.8 development cycle.

### Key Strengths

✅ **Clear separation of concerns** — PyMC vs Torch "worlds" distinction will eliminate confusion  
✅ **Eliminates duplication** — Centralizing skeleton/synthetic data definitions addresses real technical debt  
✅ **Future-proofs APIs** — Configuration hooks prepare for v0.2.1+ priors without breaking v0.1  
✅ **Maintains backward compatibility** — No mathematical behavior changes to v0.1 pipeline  
✅ **Realistic scope** — Focused on hygiene, not feature additions  

### Minor Clarifications Needed

The plan is fundamentally sound but would benefit from explicit answers to three questions before implementation:

1. **Section 1.2:** Should `project_points_pytensor` function be moved/renamed? (Currently in `pymc_model.py`, could be `pymc_camera.py`)
2. **Section 2.1:** What level of skeleton structure detail? (Just v0.1 demo skeleton, or extensible for AIST++?)
3. **Section 5.1:** Preserve existing test files or rename to stage-based convention?

These are implementation details that won't block progress.

---

## 1. Structural Assessment by Section

### Section 0: Overall Success Criteria ✅

**Status:** Excellent — provides measurable outcomes

The five success criteria are:
- Specific and testable
- Aligned with stated goals
- Appropriate for a hygiene phase

**No changes recommended.**

---

### Section 1: Clarify Torch vs PyMC Worlds ✅

**Status:** Correct approach, ready to implement

#### 1.1 Component Identification

✅ **Torch-side files correctly identified:**
- `model.py`, `inference.py`, `camera.py` — all use PyTorch tensor operations
- `examples/run_gimbal_demo.py` — imports Torch components

✅ **PyMC-side files correctly identified:**
- `hmm_pytensor.py`, `pymc_model.py`, `hmm_directional.py` — current v0.1 pipeline
- Correctly includes `pymc_utils.py`, `hmm_pymc_utils.py`

**Minor note:** `project_points_pytensor` is currently inside `pymc_model.py` (lines 30-77). If creating a more granular structure, consider:
- Option A: Leave as-is (camera projection is part of observation model)
- Option B: Extract to `pymc_camera.py` (parallel to Torch `camera.py`)

**Recommendation:** Option A for v0.2.0 (simpler), Option B can be deferred to v0.2.1+ if camera model expands.

#### 1.2 Structural Changes

✅ **Torch legacy subpackage approach is sound:**
```
gimbal/
  torch_legacy/
    __init__.py
    model.py       # moved from gimbal/model.py
    inference.py   # moved from gimbal/inference.py
    camera.py      # moved from gimbal/camera.py
```

✅ **Documentation updates appropriate:**
- README section distinguishing PyMC vs Torch
- Optional `torch_legacy/README.md` explaining status

**Implementation note:** When moving files, update:
- `examples/run_gimbal_demo.py` imports
- `gimbal/__init__.py` (currently imports `camera, model, inference`)
- Any docstrings referencing file locations

**Acceptance criteria are testable and appropriate.**

---

### Section 2: Centralize Skeleton & Synthetic Data ✅

**Status:** Addresses real technical debt, good design

#### Current State Analysis

**Skeleton duplication confirmed:**
- `notebook/demo_v0_1_complete.py` line 75: `parents = np.array([-1, 0, 1, 2, 3, 4])`
- `notebook/demo_v0_1_complete.ipynb` line 133: `parents = np.array([-1, 0, 1, 2, 3, 4])`
- `notebook/demo_pymc_skeleton.ipynb` line 96: `parents = np.array([-1, 0, 1])`
- Similar repetition in `demo_pymc_camera_simple.ipynb`, `demo_pymc_camera_full.ipynb`

**No existing `synthetic_data.py` or `skeleton_config.py` file found** — this phase will create them.

#### 2.1 Skeleton Config Module Design

✅ **`SkeletonConfig` dataclass is appropriate:**
```python
@dataclass
class SkeletonConfig:
    joint_names: list[str]
    parents: np.ndarray  # shape (K,), -1 for root
    bone_lengths: np.ndarray | None
    up_axis: np.ndarray
```

**Question for clarification:** Should this support only the v0.1 demo skeleton, or be extensible for AIST++ (coming in v0.2.5)?

**Recommendation:** 
- **Minimal for v0.2.0:** Just `DEMO_V0_1_SKELETON` constant (6 joints)
- **Nice-to-have:** Add docstring noting "will be extended for AIST++ in v0.2.5"
- **Avoid over-engineering:** Don't build full skeleton registry yet

#### 2.2 Synthetic Data Utilities

✅ **Moving synthetic generation to `synthetic_data.py` is correct:**
- Current notebooks contain ad-hoc generation code
- Consolidation will benefit v0.2.1 (anatomical priors testing) and v0.2.4 (diagnostics)

**Proposed functions are reasonable:**
```python
def generate_demo_sequence(skeleton_config, T, noise_config, ...) -> ...
def generate_demo_state_sequence(...) -> ...
```

**Implementation suggestion:** Extract from `demo_v0_1_complete.py` lines 80-160 (canonical pose generation) and lines 180-280 (state sequence simulation).

**Acceptance criteria are appropriate.**

---

### Section 3: Public API for PyMC HMM Pipeline ✅

**Status:** Critical for usability, well-designed

#### 3.1 Re-export Strategy

✅ **Core functions correctly identified:**
```python
from .hmm_pytensor import collapsed_hmm_loglik           # Stage 1
from .pymc_model import build_camera_observation_model   # Stage 2  
from .hmm_directional import add_directional_hmm_prior   # Stage 3
```

**Current `gimbal/__init__.py` only exports:**
```python
from . import camera, model, inference, fit_params  # Torch components!
```

This confirms the need for restructuring.

✅ **`__all__` definition with module-level docstring is best practice.**

#### 3.2 Naming Consistency

✅ **Canonical names are well-established in v0.1:**
- `U` (T, K, 3) — directions
- `x_all` (T, K, 3) — positions  
- `y_pred` (C, T, K, 2) — projections
- `log_obs_t` (T,) — observation log-likelihood

**Grep search confirms usage in tests:**
- `test_v0_1_3_directional_hmm.py` imports `build_camera_observation_model` and uses these names
- `test_hmm_v0_1_2.py` imports same functions
- Existing codebase is already consistent

**Recommendation:** No renaming needed, just ensure new notebooks/examples use canonical names consistently.

**Acceptance criteria are appropriate.**

---

### Section 4: Clarify vMF Distribution Status ✅

**Status:** Correct assessment, low-risk change

#### Current State

`pymc_distributions.py` defines `VonMisesFisher` (190+ lines) but:
- `hmm_directional.py` Stage 3 uses **dot-product energy**, not full vMF
- Tests still import it: `test_pymc_utils.py` line 19, `test_model_init.py` line 11

#### 4.1 Mark as Experimental

✅ **Module docstring approach is appropriate:**
```python
"""
Experimental / legacy PyMC distributions for directional data.

NOTE: The main GIMBAL-HMM pipeline (Stage 3) currently uses a
dot-product energy directional prior, not the full VonMisesFisher
distribution defined here. ...
"""
```

**Recommendation:** Add brief note explaining *why* dot-product approach was chosen (e.g., computational efficiency, sufficient for current needs).

**Test file organization:**
- `test_pymc_utils.py` and `test_model_init.py` use vMF for validation purposes (not Stage 3 pipeline)
- Keep tests as-is, just ensure they're clearly marked as testing the distribution itself

**No need for `tests/legacy/` folder in v0.2.0** — that would be premature given tests still serve validation purposes.

**Acceptance criteria are appropriate.**

---

### Section 5: Test Suite Organization ✅

**Status:** Sensible improvements, pragmatic scope

#### 5.1 Stage-Structured Tests

**Current test structure:**
```
tests/
  test_hmm_v0_1_1.py         # Stage 1 (collapsed HMM)
  test_hmm_v0_1_2.py         # Stage 2 (camera model)
  test_hmm_v0_1_3.py         # Stage 3 (directional prior)
  test_v0_1_3_directional_hmm.py  # Comprehensive Stage 3
  test_pymc_utils.py         # Utilities
  test_model_init.py         # Initialization
  test_dlt_init.py          # DLT triangulation
  run_v0_1_3_tests.py       # Test runner
```

✅ **Current naming already follows stage logic** — `v0_1_1`, `v0_1_2`, `v0_1_3` correspond to Stage 1, 2, 3.

**Question for clarification:** Should we:
- **Option A:** Keep current names (preserves history, already logical)
- **Option B:** Rename to `test_stage1_hmm.py`, etc. (more explicit)

**Recommendation:** Option A (keep current names) for v0.2.0:
- Tests already run cleanly
- Renaming provides minimal benefit vs disruption
- Can revisit in v0.3 if needed

#### 5.2 Smoke Test

✅ **Smoke test proposal is valuable:**
```python
# tests/test_demo_v0_1_smoke.py
def test_full_pipeline_builds():
    # Build complete v0.1 model from synthetic data
    # Run pm.sample_prior_predictive() only
    # Validate shapes and graph structure
```

**Implementation path:**
- Import from `synthetic_data.py` (once created in Section 2)
- Use `DEMO_V0_1_SKELETON` 
- Keep `T=10` (minimal timesteps for speed)

**This addresses a real gap** — no current test validates full model buildability end-to-end.

**Acceptance criteria are appropriate.**

---

### Section 6: Minimal "Hello World" Demo ✅

**Status:** Valuable addition, clear requirements

✅ **`examples/demo_pymc_pipeline.py` is good idea:**
- Complements existing `run_gimbal_demo.py` (Torch) with PyMC equivalent
- Helps onboarding and AI coding assistants
- Serves as integration test

**Proposed content is appropriate:**
1. Import skeleton config
2. Generate tiny synthetic data (T=20 is good choice)
3. Build Stage 2 model
4. Add Stage 3 prior
5. Run short sampling or prior predictive
6. Print summary

**Suggested addition:** Add `if __name__ == "__main__":` block so it can run as:
```powershell
python examples/demo_pymc_pipeline.py
```

(Not just `python -m gimbal.examples.demo_pymc_pipeline`)

**Acceptance criteria are appropriate.**

---

### Section 7: Configuration for Future Priors ✅

**Status:** Forward-thinking, minimally invasive

#### 7.1 Prepare Configuration Hooks

✅ **Adding optional prior config parameters is smart:**
```python
def add_directional_hmm_prior(
    U, log_obs_t, S,
    prior_config=None,  # NEW: dict with future prior settings
    # ... existing params
):
    if prior_config is None:
        prior_config = {}  # v0.1 behavior
```

**Alternative approach (slightly more structured):**
```python
PRIOR_MODE_NONE = "none"
PRIOR_MODE_COARSE_ANATOMICAL = "coarse_anatomical"
PRIOR_MODE_DATA_DRIVEN = "data_driven"

def add_directional_hmm_prior(
    U, log_obs_t, S,
    prior_mode=PRIOR_MODE_NONE,  # v0.1 default
    prior_hyperparams=None,      # mode-specific params
    ...
):
```

**Recommendation:** Either approach works. The plan's `prior_config` dict is simpler for v0.2.0.

**Key requirement:** Default behavior must be identical to v0.1 (no priors added).

**Acceptance criteria are appropriate.**

---

### Section 8: Documentation & README Updates ✅

**Status:** Essential, well-specified

#### Current README State

**Existing README already documents v0.1 well:**
- Lists all three phases (v0.1.1, v0.1.2, v0.1.3)
- Has repository structure section
- Points to `plans/` directory

**Missing from current README:**
- Distinction between PyMC (current) vs Torch (legacy)
- "Getting started" guidance
- Clear pointer to hello-world demo

#### 8.1 README Updates

✅ **Proposed new sections are appropriate:**
```markdown
## Current Pipeline (PyMC HMM, v0.1+)
- Stage 1–3 summary

## Legacy Torch GIMBAL
- Historical note

## Examples
- Point to demo_pymc_pipeline.py and key notebooks

## Development Roadmap
- Link to plans/v0.2-overview.md
```

**Recommendation:** Also add "Quick Start" section showing minimal usage:
```python
import gimbal
from gimbal import DEMO_V0_1_SKELETON

# Generate synthetic data
data = gimbal.generate_demo_sequence(DEMO_V0_1_SKELETON, T=50)

# Build model
model, U, x_all, y_pred, log_obs_t = gimbal.build_camera_observation_model(...)
gimbal.add_directional_hmm_prior(U, log_obs_t, ...)
```

#### 8.2 plans/ Directory

✅ **File naming:** `v0_2_0_repo_hygiene.md` or `v0.2.0-detailed-spec.md`?

Current pattern is `v0.1.X-detailed-spec.md`, so **recommend `v0.2.0-detailed-spec.md`** for consistency.

**Acceptance criteria are appropriate.**

---

### Section 9: Branching / Versioning ✅

**Status:** Good practices, already done

#### Git Tag Status

**From conversation summary:**
```powershell
git tag -a v0.1 -m "Completed version 0.1"
git push origin v0.1
```

✅ **v0.1 already tagged** — Section 9.1 task #1 is complete.

#### 9.1 Remaining Tasks

✅ **Branching strategy recommendation:**
- **v0.2.0 is non-breaking** — safe to work on `main`
- Could use `v0.2.0-restructuring` branch for review, merge to `main` when complete
- Tag as `v0.2.0` when finished

✅ **CONTRIBUTING.md suggestion is valuable** but not blocking:
- Can defer to post-v0.2.0
- More important once AIST++ integration brings external contributors (v0.2.5+)

**Acceptance criteria are appropriate.**

---

### Section 10: Non-Goals ✅

**Status:** Excellent scope discipline

✅ **Explicitly excludes:**
- Mathematical changes to Stage 1–3 ✓
- Anatomical priors (v0.2.1) ✓
- AIST++ loaders (v0.2.5+) ✓
- PCA-based priors (v0.2.7–0.2.8) ✓

This clarity will prevent scope creep during implementation.

---

## 2. Implementation Readiness Assessment

### Prerequisites Check

✅ **v0.1 complete and stable**
- Completion reports exist for v0.1.1, v0.1.2, v0.1.3
- Tests pass (evidenced by test file maturity)
- Tagged as `v0.1`

✅ **No blocking dependencies:**
- All work is internal reorganization
- No external API changes required
- No new algorithmic components

### Risk Assessment

**Low Risk:**
- File moves with import updates (standard refactoring)
- Adding new modules (`skeleton_config.py`, `synthetic_data.py`)
- Documentation updates
- Test organization

**Medium Risk (easily mitigated):**
- Breaking existing notebook imports → **Mitigation:** Test each notebook after changes
- Torch demo breakage → **Mitigation:** Test `examples/run_gimbal_demo.py` explicitly

**No High Risk items identified.**

### Effort Estimate

**By section:**
1. Torch/PyMC separation: 2-3 hours (file moves + import updates)
2. Skeleton/synthetic centralization: 3-4 hours (extraction + notebook updates)
3. Public API: 1-2 hours (`__init__.py` updates + docstrings)
4. vMF clarification: 30 minutes (docstring addition)
5. Test organization: 1-2 hours (smoke test creation)
6. Hello world demo: 2-3 hours (script creation + testing)
7. Config hooks: 1 hour (signature updates)
8. Documentation: 2-3 hours (README rewrite)
9. Branching/versioning: 30 minutes (tagging)

**Total estimated effort: 13-19 hours** (approximately 2-3 focused work sessions)

---

## 3. Recommended Implementation Order

The plan sections have some dependencies. Suggested order:

### Phase 1: Infrastructure (Sections 2, 7)
1. Create `gimbal/skeleton_config.py` with `DEMO_V0_1_SKELETON`
2. Create `gimbal/synthetic_data.py` with generation utilities
3. Add `prior_config` parameter hooks to `add_directional_hmm_prior`

**Rationale:** Establishes foundation that later steps depend on.

### Phase 2: Reorganization (Sections 1, 4)
4. Create `gimbal/torch_legacy/` and move files
5. Update `examples/run_gimbal_demo.py` imports
6. Add experimental note to `pymc_distributions.py`

**Rationale:** Structural changes before API work.

### Phase 3: API & Tests (Sections 3, 5)
7. Update `gimbal/__init__.py` with PyMC re-exports
8. Create `tests/test_demo_v0_1_smoke.py`
9. Update notebooks to use centralized skeleton/synthetic utilities

**Rationale:** Public-facing API after internals are stable.

### Phase 4: Examples & Docs (Sections 6, 8)
10. Create `examples/demo_pymc_pipeline.py`
11. Update `README.md` with new structure
12. Create/update `plans/v0.2.0-detailed-spec.md` (this plan document)

**Rationale:** User-facing materials after implementation complete.

### Phase 5: Validation & Tagging (Section 9)
13. Run full test suite
14. Test all notebooks
15. Test both demo scripts
16. Tag as `v0.2.0`

---

## 4. Clarification Questions for User

Before implementation, please confirm:

### Q1: Project Points Function
Should `project_points_pytensor` remain in `pymc_model.py` or be extracted to separate file?
- **Option A:** Leave in `pymc_model.py` (simpler for v0.2.0)
- **Option B:** Extract to `gimbal/pymc_camera.py` (parallel to Torch `camera.py`)

**Recommendation:** Option A

### Q2: Skeleton Extensibility
Should `SkeletonConfig` support only v0.1 demo or prepare for AIST++?
- **Option A:** Minimal (just `DEMO_V0_1_SKELETON`)
- **Option B:** Extensible (docstring noting future AIST++ support)

**Recommendation:** Option A with docstring mentioning v0.2.5

### Q3: Test File Renaming
Should v0.1 test files be renamed to stage-based convention?
- **Option A:** Keep current names (`test_hmm_v0_1_X.py`)
- **Option B:** Rename to `test_stageX_*.py`

**Recommendation:** Option A

---

## 5. Success Criteria Validation

The plan's Section 0 success criteria are **measurable and appropriate:**

### Criterion 1: Documented PyMC HMM "world"
✅ Will be satisfied by:
- `gimbal/__init__.py` re-exports (Section 3.1)
- Module-level docstrings (Section 3.1)
- `examples/demo_pymc_pipeline.py` (Section 6)

### Criterion 2: Torch code separated
✅ Will be satisfied by:
- `gimbal/torch_legacy/` subpackage (Section 1.2)
- README documentation (Section 8.1)

### Criterion 3: Canonical skeleton/synthetic data
✅ Will be satisfied by:
- `skeleton_config.py` with `DEMO_V0_1_SKELETON` (Section 2.1)
- `synthetic_data.py` with utilities (Section 2.2)

### Criterion 4: Test suite health
✅ Will be satisfied by:
- Smoke test `test_demo_v0_1_smoke.py` (Section 5.2)
- All existing tests updated for new imports (Section 1.2)

### Criterion 5: README and hello-world demo
✅ Will be satisfied by:
- `examples/demo_pymc_pipeline.py` (Section 6)
- Updated `README.md` (Section 8.1)

**All criteria are achievable within the proposed scope.**

---

## 6. Additional Recommendations (Optional)

These are **not required** for v0.2.0 but would be valuable:

### 6.1 Module Docstrings
Add comprehensive module-level docstrings to:
- `hmm_pytensor.py` — explain Stage 1 forward algorithm
- `pymc_model.py` — explain Stage 2 camera + kinematics
- `hmm_directional.py` — explain Stage 3 directional prior

**Benefit:** Improves auto-generated documentation and AI assistant understanding.

### 6.2 Type Hints Audit
The plan doesn't mention type hints, but adding them would:
- Catch import errors during reorganization
- Improve IDE support for new public API
- Help future contributors

**Scope:** Could be deferred to v0.2.1+ if it adds too much work.

### 6.3 Notebook Cell Output Clearing
Before committing restructured notebooks:
- Clear all cell outputs
- Add note at top: "Run all cells to regenerate outputs"

**Benefit:** Reduces git diff noise and repo size.

---

## 7. Final Recommendation

**STATUS: APPROVED FOR IMPLEMENTATION**

The v0.2.0 restructuring plan is:
- ✅ **Well-scoped** — focuses on hygiene, not features
- ✅ **Low-risk** — no mathematical changes, clear rollback path
- ✅ **High-value** — eliminates duplication, clarifies structure, prepares for v0.2.1+
- ✅ **Implementable** — no blocking dependencies or ambiguous requirements

### Proceed with implementation in the order suggested in Section 3.

Minor clarifications in Section 4 can be resolved during implementation without blocking progress. Default to simpler options (Option A) when in doubt.

### Post-Implementation Checklist

Before tagging v0.2.0:
- [ ] All tests pass (`pytest`)
- [ ] Both demo scripts run (`run_gimbal_demo.py`, `demo_pymc_pipeline.py`)
- [ ] All notebooks execute without errors
- [ ] README accurately describes new structure
- [ ] No mathematical behavior changes to v0.1 pipeline (verified by running v0.1 smoke test)

### Estimated Timeline
**2-3 focused work sessions** (13-19 hours total)

---

## Appendix: File Move Checklist

For implementation reference:

### Files to Move
```
gimbal/model.py         → gimbal/torch_legacy/model.py
gimbal/inference.py     → gimbal/torch_legacy/inference.py
gimbal/camera.py        → gimbal/torch_legacy/camera.py
```

### Files to Create
```
gimbal/skeleton_config.py
gimbal/synthetic_data.py
examples/demo_pymc_pipeline.py
tests/test_demo_v0_1_smoke.py
gimbal/torch_legacy/__init__.py
gimbal/torch_legacy/README.md (optional)
```

### Files to Update
```
gimbal/__init__.py                  # New PyMC re-exports
gimbal/hmm_directional.py          # Add prior_config parameter
gimbal/pymc_distributions.py       # Add experimental note
examples/run_gimbal_demo.py        # Update imports to torch_legacy
README.md                           # Major rewrite
notebook/*.ipynb                    # Update to use skeleton_config, synthetic_data
plans/v0.2.0-detailed-spec.md      # Add this plan document
```

### Import Updates Required
Search codebase for:
```python
from gimbal.model import ...
from gimbal.inference import ...
from gimbal.camera import ...
```

Replace with:
```python
from gimbal.torch_legacy.model import ...
from gimbal.torch_legacy.inference import ...
from gimbal.torch_legacy.camera import ...
```

**Estimated: 3-4 locations** (mainly `examples/run_gimbal_demo.py`)

---

**End of Review**
