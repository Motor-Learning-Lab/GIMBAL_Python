# v0.2.1 Spec–Code Alignment Plan (v2)

**Status:** Ready for implementation  
**Updated:** 2025-12-15  
**Objectives:**
1. Audit all v0.2.1 specs against current code
2. Organize plans/specs by type and maturity
3. Document divergences and establish resolution rules
4. Produce comprehensive alignment report

---

## Phase 0: Organization & Structure (NEW)

Before alignment work begins, the `plans/` directory must be restructured to distinguish different types of documents. This improves navigation and prevents confusion between canonical specs and historical debugging notes.

### Current Problem
The `plans/` directory is a flat "big bag of stuff" containing:
- **Canonical specifications** (GIMBAL spec.md, v0.1.x-detailed-spec.md)
- **Active v0.2.1 specs** (data-driven priors, divergence analysis)
- **Completion reports** (v0.1.1, v0.1.2, v0.2.0, v0.2.1)
- **Debug plans & analyses** (divergence plans, ground truth debugging, etc.)
- **Historical reviews & iterations** (v0.2-review-iteration1, etc.)
- **Architectural notes** (blended-local-frame-design, coordinates)

### Solution: Directory Reorganization

Create subdirectories under `plans/` to categorize by type and maturity:

```
plans/
├── README.md                            # Navigation guide (new)
│
├── canonical/                           # Stable, reference specs (canonical authority)
│   ├── GIMBAL-spec.md                   # Core algorithm spec (root of truth)
│   ├── v0.1.1-detailed-spec.md          # v0.1.1 final spec (archived, reference)
│   ├── v0.1.2-detailed-spec.md          # v0.1.2 final spec (archived, reference)
│   ├── v0.1.3-detailed-spec.md          # v0.1.3 final spec (archived, reference)
│   └── README.md                        # Guide: these are frozen specs for versions
│
├── active/                              # Current v0.2.1 development specs
│   ├── v0.2.1-overview.md               # v0.2.1 scope & architecture
│   ├── v0.2.1-spec-data-driven-priors.md # Feature spec for data-driven priors
│   ├── v0.2.1-spec-camera-model.md      # [INFERRED] Feature spec for camera observation model
│   ├── v0.2.1-spec-hierarchical-rw.md   # [INFERRED] Feature spec for root RW dynamics
│   ├── v0.2.1-divergence-analysis.md    # Root cause analysis of divergence (consolidated)
│   └── README.md                        # Guide: these are active specs for current work
│
├── completion-reports/                 # Version completion reports (archival)
│   ├── v0.1.1-completion-report.md      # v0.1.1 finished
│   ├── v0.1.2-completion-report.md      # v0.1.2 finished
│   ├── v0.1.3-completion-report.md      # v0.1.3 finished
│   ├── v0.2.0-completion-report.md      # v0.2.0 finished
│   ├── v0.2.1-completion-report.md      # v0.2.1 finished
│   └── README.md                        # Guide: these confirm what was delivered
│
├── archive/                             # Historical debugging, iterations, reviews
│   ├── v0.2.1-divergence-tg01-08.md                    # Groups 1-8 test results (superseded by Issues I1-I3)
│   ├── v0.2.1-divergence-plan-2.md                     # Issue-based divergence debugging (active but being consolidated)
│   ├── v0.2.1-debug-ground-truth-test-plan.md          # Ground truth debugging (completed, archived)
│   ├── v0.2.1-debug-ground-truth-results.md            # Ground truth results (completed, archived)
│   ├── v0.2.1-debug-model-no-hmm-plan.md               # HMM debugging (completed, archived)
│   ├── v0.2.1-debug-initialization-logp.md             # Logodds fix work (completed, archived)
│   ├── v0.2-review-iteration1.md                       # Design review (v0.2 era)
│   ├── v0.2-biomechanical-priors-notes.md              # Design explorations
│   ├── v0.1-review-iteration2.md                       # Historical design review (v0.1 era)
│   ├── v0.1.1-review-improvements.md                   # Historical improvements (v0.1 era)
│   ├── v0.1.1-review-revision3.md                      # Historical revision (v0.1 era)
│   ├── v0.1.2-review1.md                               # Historical review (v0.1 era)
│   ├── v0.1.2-spec-prompt.md                           # Historical spec generation (v0.1 era)
│   ├── coordinates.md                                   # Coordinate system design (timeless)
│   ├── blended-local-frame-design.md                   # Frame design exploration (timeless)
│   ├── v0.2-planning-chatgpt.md                        # Historical planning notes
│   ├── v0.1-overview.md                                # v0.1 overview (superseded by v0.2)
│   ├── v0.2-overview.md                                # v0.2 overview (superseded by v0.2.1)
│   ├── v0.2.0-detailed-plan.md                         # v0.2.0 planning (completed)
│   ├── v0.2.1-cleanup-plan.md                          # Cleanup planning
│   ├── v0.2.1-cleanup-suggestions.md                   # Cleanup suggestions
│   ├── v0.2.1-spec-review-comments.md                  # Review feedback
│   ├── v0.2.0-review.md                                # v0.2.0 review
│   ├── v0.2.1-divergence-plan-addition.md              # Divergence plan additions
│   ├── v0.2.1-divergence-i1-plan-review.md             # Issue I1 review
│   └── README.md                        # Guide: these are no longer active; kept for reference only
│
└── README.md                            # NEW: Top-level navigation guide
```

### Rationale for Structure

1. **canonical/** — These are frozen reference specs. They define what each versioned release actually contains. Essential for understanding API stability and backward compatibility.

2. **active/** — These are the working specs for the current version (v0.2.1). When specifications diverge from code, they should be in this folder. Once v0.2.1 is released, these move to `canonical/` as `v0.2.1-detailed-spec.md`.

3. **completion-reports/** — These confirm what was delivered in each version. They are archival and should not change. Useful for auditing what was promised vs. delivered.

4. **archive/** — Historical work that informed current design but is no longer active. Kept to preserve intellectual history and to enable recovery of old decisions if needed.

### Step 0.1: Create Directory Structure

Create the subdirectories and move existing files:

```bash
mkdir -p plans/canonical plans/active plans/completion-reports

# Move canonical specs
mv plans/GIMBAL\ spec.md plans/canonical/
mv plans/v0.1.1-detailed-spec.md plans/canonical/
mv plans/v0.1.2-detailed-spec.md plans/canonical/
mv plans/v0.1.3-detailed-spec.md plans/canonical/

# Move completion reports
mv plans/v0.1.1-completion-report.md plans/completion-reports/
mv plans/v0.1.2-completion-report.md plans/completion-reports/
mv plans/v0.1.3-completion-report.md plans/completion-reports/
mv plans/v0.2.0-completion-report.md plans/completion-reports/
mv plans/v0.2.1-completion-report.md plans/completion-reports/

# Move everything else to archive/ (already exists)
mv plans/v0.* plans/archive/
mv plans/*.md plans/archive/ (except README.md files)
```

### Step 0.2: Create README Files for Each Directory

**plans/README.md** (top-level navigation):
```markdown
# GIMBAL Plans & Specifications

Navigate by maturity and purpose:

- **canonical/** — Frozen specs for released versions (reference authority)
- **active/** — Working specs for v0.2.1 development (primary alignment target)
- **completion-reports/** — What was delivered in each release (archival)
- **archive/** — Historical work, design explorations, and debugging notes (reference only)

See subdirectory README.md files for detailed guidance.
```

**plans/canonical/README.md**:
```markdown
# Canonical Specifications

These are **frozen reference documents** for each released version of GIMBAL. 

They define:
- Model architecture (latent variables, priors, likelihood)
- Algorithm (inference, sampling, initialization)
- API contracts (what functions/classes/exports are stable)
- Data formats (inputs, outputs, intermediate representations)

Use these when:
- Understanding what a specific version implements
- Auditing backward compatibility
- Tracing design decisions that led to current state

Do NOT edit these files. To modify a canonical spec, release a new version.
```

**plans/active/README.md**:
```markdown
# Active v0.2.1 Specifications

These are the **working specifications** for the current development version (v0.2.1).

When v0.2.1 is released, these will be moved to `canonical/` as a frozen reference.

Primary documents:
- **v0.2.1-overview.md** — Scope and architecture
- **v0.2.1-spec-data-driven-priors.md** — Data-driven priors feature
- **v0.2.1-spec-camera-model.md** — Camera observation model [TO BE CREATED]
- **v0.2.1-spec-hierarchical-rw.md** — Root trajectory dynamics [TO BE CREATED]
- **v0.2.1-divergence-analysis.md** — Root cause analysis and fix strategy [TO BE CREATED FROM DIVERGENCE PLAN]

These specs are the **primary source of truth** during alignment. Code is measured against these.
```

**plans/completion-reports/README.md**:
```markdown
# Completion Reports

Each report documents what was delivered in a version:
- Features implemented
- Tests passed
- Bugs fixed
- Known limitations

These are **archival and immutable**. They provide an audit trail of progress.

Useful for:
- Understanding what a version contains without reading source code
- Auditing delivered vs. promised features
- Tracing when a feature was introduced or a bug was fixed
```

**plans/archive/README.md**:
```markdown
# Archive: Historical Work

This folder contains:
- **Debugging plans & results** (divergence analysis, ground truth issues, etc.) — kept because they document important discoveries
- **Design explorations** (frame choices, coordinate systems) — kept because they explain current decisions
- **Historical reviews & iterations** — kept for intellectual history
- **Superseded specs** (v0.2-overview, v0.1-overview) — kept for reference

These are **no longer active** and should not be edited. They are kept to:
- Preserve intellectual history
- Enable recovery of old decisions
- Understand why the system is designed the way it is

If you find yourself reading files here, consider whether the information should be moved to `active/` or `canonical/`.
```

---

## Phase 1: Build Spec–Code Map (Current Plan, Refined)

This phase follows the organization above. We now work with properly categorized specs.

### Step 1.1: Identify Canonical Authority

From `canonical/GIMBAL-spec.md`, extract the core promises:

| Aspect | Spec Says | Authority |
|--------|-----------|-----------|
| Root dynamics | GaussianRandomWalk (centered) with hierarchical variance | Canonical v0.1+ |
| Directional vars | Unit vectors, parameterized as Gaussian-normalize | Canonical v0.1+ |
| Likelihood | Multi-camera Gaussian observations with mixture for outliers | Canonical v0.1+ |
| HMM prior | Optional Stage 3, directional vMF emissions | Canonical v0.1.3 |
| Data-driven priors | Build joint direction priors from empirical data | Active v0.2.1 spec |

### Step 1.2: Map to Code

For each spec requirement, identify code locations:

| Spec Source | Requirement | Code Location(s) | Status |
|-------------|-------------|------------------|--------|
| Canonical: Root dynamics | GaussianRandomWalk with `eta2_root` prior | `gimbal/pymc_model.py:450-465` | ✅ Implemented |
| Canonical: Directional | Gaussian-normalize parameterization | `gimbal/pymc_model.py:470-490` | ✅ Implemented |
| Canonical: Likelihood | Gaussian + mixture | `gimbal/pymc_model.py:530-590` | ✅ Implemented (logodds fix applied) |
| Active v0.2.1: Data-driven priors | Empirical direction stats → prior configs | `gimbal/prior_building.py` | ✅ Implemented |
| Canonical: HMM prior | Stage 3 directional vMF | `gimbal/hmm_directional.py` | ✅ Implemented |

(Detailed mapping to follow in full alignment report)

---

## Phase 2: Detect & Classify Mismatches

### Known Mismatches (From Divergence Work)

**Mismatch 1: Centered Parameterization Creates Hierarchical Coupling**
- **Spec source:** Canonical GIMBAL spec.md (Section 2.1: Root dynamics)
- **Code location:** `gimbal/pymc_model.py` lines 450-465
- **Type:** Code-ahead (spec doesn't discuss parameterization choice)
- **Description:** Spec defines centered parameterization `x_root[t] ~ GRW(sigma=sqrt(eta2_root))` but doesn't discuss how this couples exploration of `eta2_root` and `x_root`. Recent divergence debugging (v0.2.1_divergence_plan_2.md) identified this as a critical pathology causing hierarchical funnel geometry. Proposed fix: non-centered reparameterization.
- **Tests affected:** All integration tests in `tests/diagnostics/v0_2_1_divergence/`
- **Recommendation:** **Defer** with NEEDS_DECISION tag. This requires a design choice: accept centered (and live with divergence mitigation work) or implement non-centered (and verify it doesn't break other assumptions). See divergence analysis for technical details.
- **Rationale:** Reparameterization is a known solution to hierarchical sampling problems, but it's a breaking change to model structure. Should be decided explicitly, not applied silently.

**Mismatch 2: Logodds Parameterization for `inlier_prob`**
- **Spec source:** Canonical GIMBAL spec.md (Section 2.3: Observation model)
- **Code location:** `gimbal/pymc_model.py` lines 549-550
- **Type:** Code-ahead (spec doesn't mention parameterization)
- **Description:** Spec defines mixture likelihood with `inlier_prob` as a parameter but doesn't specify how to parameterize it (Beta? Unbounded?). Code uses logodds (Normal on unconstrained space + sigmoid transform) to avoid -inf issues. This is an approved improvement documented in ground truth debugging tests.
- **Tests affected:** `tests/diagnostics/v0_2_1_divergence/test_ground_truth_init.py` (✅ passes)
- **Recommendation:** **Align spec to code**. Update GIMBAL spec.md Section 2.3 to document logodds parameterization as the authoritative approach.
- **Rationale:** Logodds is a well-known best practice for probability parameters. The fix is sound and approved by test results.

**Mismatch 3: Camera Projection Geometry Pathology (NEW FINDING)**
- **Spec source:** Canonical GIMBAL spec.md (Section 2.4: Camera model)
- **Code location:** `gimbal/pymc_model.py` function `project_points_pytensor()`
- **Type:** Code-is-correct, spec-incomplete
- **Description:** Spec defines pinhole camera model with perspective division but doesn't document that this creates pathological geometry when combined with hierarchical root RW. Recent divergence debugging (v0.2.1_divergence_plan_2.md, Issues I2) revealed that perspective projection depth-division creates extreme curvature in the log-posterior. Proposed solution: investigate orthographic projection or other projection models as alternatives.
- **Tests affected:** `tests/diagnostics/v0_2_1_divergence/test_tg10_*.py` (Issue I2 tests)
- **Recommendation:** **Defer** with NEEDS_DECISION_DESIGN. Document in divergence analysis but don't change code without explicit decision.
- **Rationale:** Switching projection models is a fundamental change. Should be decided at the architectural level.

(More mismatches to follow in full alignment report)

---

## Phase 3: Apply Resolution Rules & Decision Points

### Decision Rule Matrix

| Case | Rule | Action |
|------|------|--------|
| Spec & code aligned, tests pass | A (Favor code) | ✅ Document as aligned |
| Spec says X, code does Y, tests prefer Y | A (Favor code) | ✅ Mark for spec update |
| Spec says X, code does Y, ambiguous | C (Defer) | ⏳ Tag NEEDS_DECISION |
| Spec says X, code doesn't implement X | B (Favor spec) | ❓ Create task/TODO |
| Spec incomplete (doesn't say X or Y) | A+C (Hybrid) | ⏳ Document as open, tag NEEDS_DECISION if architectural |

### Decision Tags

All deferred decisions will be tagged as follows:

```markdown
**NEEDS_DECISION_DESIGN:** Requires architectural choice (e.g., centered vs. non-centered)
**NEEDS_DECISION_PERFORMANCE:** Trade-off between accuracy and efficiency
**NEEDS_DECISION_SCOPE:** Out of v0.2.1 scope; document for v0.2.2 or later
**NEEDS_DECISION_TEST:** Behavior inconsistent with tests; needs clarification
```

---

## Phase 4: Tag Code with Non-Intrusive Markers (Optional)

For each mismatch classified as deferred or code-ahead-of-spec, propose a comment in the alignment report:

**Example (do NOT apply yet):**
```python
# TODO[v0.2.1-ALIGNMENT]: Centered GaussianRandomWalk creates hierarchical coupling
# See: plans/active/v0.2.1-divergence-analysis.md (Issue I2)
# Status: NEEDS_DECISION_DESIGN (non-centered alternative proposed but not approved)
x_root = pm.GaussianRandomWalk(
    "x_root", mu=0, sigma=pt.sqrt(eta2_root), shape=(T, 3), initval=x_root_init
)
```

These are proposed only in the alignment report; they are NOT applied to code.

---

## Phase 5: Final Deliverables

### Output: plans/active/v0.2.1_spec_code_alignment_report.md

Contents:

1. **Executive Summary**
   - Overview of alignment status
   - Summary counts: X aligned, Y code-ahead, Z spec-ahead, W deferred

2. **Spec→Code Map (Table)**
   - Every major requirement from active/canonical specs mapped to code

3. **Mismatches (One section per mismatch)**
   - Source, location, classification, description, tests affected, recommendation, rationale

4. **Decision Points (Table)**
   - All NEEDS_DECISION_* items extracted and summarized
   - Can be handed to user for prioritization

5. **Proposed TODOs (Appendix)**
   - Exact comment text for each mismatch (for future application to code)

6. **Completion Checklist**
   - ✅ All major modules reviewed
   - ✅ All active/canonical specs reviewed
   - ✅ N mismatches identified and classified
   - ✅ Major specs compared (are they consistent?)
   - ✅ Code compared to detailed specs
   - ✅ All NEEDS_DECISION items extracted

### Also Produce:

- **plans/active/README.md** (updated to reflect actual specs)
- **plans/README.md** (top-level navigation)
- **Directory structure** (reorganized as per Phase 0)

---

## Implementation Sequence

1. **Phase 0 (Organization)** → Create directory structure, move files, write README files
2. **Phase 1 (Mapping)** → Extract spec requirements, locate code, build map table
3. **Phase 2 (Detection)** → Identify all mismatches, classify them
4. **Phase 3 (Resolution)** → Apply decision rules, tag decision points
5. **Phase 4 (Markers)** → Propose TODOs (don't apply yet)
6. **Phase 5 (Report)** → Consolidate into alignment report
7. **Final Review** → Re-read and re-assess entire result from scratch

---

## Completion Criteria

- [ ] All canonical and active specs read and summarized
- [ ] All major code modules (`pymc_model.py`, `pymc_utils.py`, `hmm_directional.py`, `prior_building.py`, etc.) reviewed
- [ ] Spec→code map populated with ≥90% coverage of major features
- [ ] All mismatches classified (Aligned, Code-ahead, Spec-ahead, Conflict, Deferred)
- [ ] All NEEDS_DECISION items tagged and extracted
- [ ] Alignment report complete and coherent
- [ ] Final re-read and re-assessment performed
- [ ] User able to prioritize remaining decisions
