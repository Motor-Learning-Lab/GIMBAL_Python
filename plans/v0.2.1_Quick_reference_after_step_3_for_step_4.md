# GIMBAL v0.2.1 ‚Äî Quick Reference for Step 4 Planning

**Last Updated:** December 19, 2025  
**Current State:** Step 3 Complete, Ready for Step 4 (Real Data Pipeline)

## üìö Canonical Documentation

### Step 3 (Synthetic Data) ‚Äî **COMPLETE**

**Primary References:**
1. **[v0.2.1_step3_completion_summary.md](v0.2.1_step3_completion_summary.md)** ‚Üê **START HERE**
   - Comprehensive "as implemented" architecture
   - Exit criteria checklist
   - Known issues and v0.2.2 deferred items

2. **[v0.2.1_step3_synthetic_data_generation.md](v0.2.1_step3_synthetic_data_generation.md)**
   - Original plan (now implemented)
   - Camera visualization, identifiability, second-order dynamics

3. **[v0.2.1_step3_clarifications_and_questions.md](v0.2.1_step3_clarifications_and_questions.md)**
   - Design decisions and resolved questions

### Overall v0.2 Roadmap

**[v0.2-overview.md](v0.2-overview.md)** - Eight-phase roadmap including:
- 0.2.1: Coarse anatomical priors & basic cleaning ‚úÖ (mostly done)
- 0.2.2-0.2.8: Future phases

### Implementation Status

**[v0.2.1_completion_report.md](v0.2.1_completion_report.md)** - Data-driven priors implementation report

## üîÑ Real Data Processing Pipeline (Intended Flow)

The intended toolchain order for real motion capture data:

```
Raw Multi-Camera 2D Keypoints
           ‚Üì
    [1. 2D Cleaning]
    - Outlier detection
    - Temporal consistency
    - gimbal.data_cleaning.clean_keypoints_2d()
           ‚Üì
    [2. Triangulation]
    - Multi-view 3D reconstruction
    - gimbal.triangulation.triangulate_multi_view()
           ‚Üì
    [3. 3D Cleaning]
    - Bone length validation
    - Temporal smoothing
    - gimbal.data_cleaning.clean_keypoints_3d()
           ‚Üì
    [4. Prior Building]
    - Compute directional statistics
    - gimbal.direction_statistics.compute_direction_statistics()
    - gimbal.prior_building.build_priors_from_statistics()
           ‚Üì
    [5. Model Building]
    - Stage 1: Collapsed HMM (gimbal.collapsed_hmm_loglik)
    - Stage 2: Camera observation (gimbal.build_camera_observation_model)
    - Stage 3: Directional HMM (gimbal.add_directional_hmm_prior)
           ‚Üì
    [6. Fitting/Sampling]
    - Initialize: gimbal.fit_params.initialize_from_observations()
    - Sample: nutpie or PyMC samplers
    - Diagnostics: R-hat, ESS, divergences
```

**Status:** Steps 1-4 have partial implementations (v0.2.1 data-driven priors demo). Step 4 needs to formalize the full pipeline.

## üóÇÔ∏è Current Code Organization

### Library Modules (gimbal/)

**Core Pipeline (v0.1):**
- `hmm_pytensor.py` - Stage 1: Collapsed HMM engine
- `pymc_model.py` - Stage 2: Camera observation model
- `hmm_directional.py` - Stage 3: Directional HMM prior

**Data Processing (v0.2.1):**
- `triangulation.py` - Multi-view 3D reconstruction
- `data_cleaning.py` - 2D/3D outlier detection and smoothing
- `direction_statistics.py` - Directional statistics computation
- `prior_building.py` - Build PyMC priors from statistics

**Synthetic Data (Step 3):**
- `synthetic_data.py` - Motion generation with second-order dynamics
- `skeleton_config.py` - Skeleton structure definitions
- `skeleton_metrics.py` - Quality metrics (5 functions)
- `skeleton_visualization.py` - Diagnostic plots (4 functions)
- `identifiability.py` - 3-tier camera identifiability checking

**Utilities:**
- `camera_utils.py` - Projection matrices
- `fit_params.py` - Initialization helpers

### Test Pipeline (tests/pipeline/)

**Synthetic Data Generation:**
- `generate_dataset.py` - Runner script
- `test_v0_2_1_synth_generator.py` - Integration tests
- `datasets/` - L00-L03 canonical datasets (configs versioned, artifacts regenerated)
- `utils/` - Thin wrappers (config_generator, metrics, visualization)

**Usage:**
```bash
pixi run generate-datasets v0.2.1_L00_minimal v0.2.1_L01_noise
pixi run test-pipeline
```

## üéØ Step 4 Planning Context

### What Step 4 Should Build

Based on v0.2-overview.md phases, Step 4 likely involves:

**Option A: Formalize Real Data Pipeline (Phase 0.2.5-ish)**
- Public dataset loader (AIST++, Human3.6M, or similar)
- End-to-end pipeline: 2D ‚Üí clean ‚Üí triangulate ‚Üí 3D clean ‚Üí priors ‚Üí model ‚Üí fit
- Integration test with real data
- Compare against synthetic baseline

**Option B: Advanced Diagnostics (Phase 0.2.4)**
- Fit quality metrics (R-hat, ESS, divergences)
- State trajectory visualization
- Transition matrix analysis
- Comparison tools (synthetic vs real, different configs)

**Option C: Sampler Evaluation (Phase 0.2.3)**
- Compare nutpie vs JAX-HMC vs PyMC-NUTS
- Benchmark on synthetic L00-L03
- Document recommended sampler

### What Already Exists

‚úÖ **Complete:**
- Three-stage HMM pipeline (v0.1)
- Data-driven priors toolchain (v0.2.1)
- Synthetic data generation (Step 3)
- Camera visualization and identifiability checking

‚ö†Ô∏è **Partial:**
- Real data cleaning (basic implementations exist)
- Triangulation (implemented but not extensively tested on real data)
- Prior building (works on synthetic, not tested on real)

‚ùå **Missing:**
- Public dataset loaders (AIST++, H3.6M)
- End-to-end real data integration test
- Comprehensive diagnostics module
- Sampler comparison framework

## üìñ Key Technical Documents

### Camera Projection
- **[docs/camera_projection_technical_report.md](../docs/camera_projection_technical_report.md)**
- **[docs/CAMERA_FIX_SUMMARY.md](../docs/CAMERA_FIX_SUMMARY.md)**

### Specifications
- **[GIMBAL spec.md](../GIMBAL%20spec.md)** - Mathematical formulation
- **[v0.2.1_spec_data_driven_priors.md](v0.2.1_spec_data_driven_priors.md)** - Data-driven priors spec

### Examples
- **[examples/demo_v0_2_1_data_driven_priors.py](../examples/demo_v0_2_1_data_driven_priors.py)** - End-to-end demo
- **[notebook/demo_v0_2_1_data_driven_priors.ipynb](../notebook/demo_v0_2_1_data_driven_priors.ipynb)** - Interactive walkthrough

## üöÄ Recommended Next Steps (Step 4)

1. **Read [v0.2.1_step3_completion_summary.md](v0.2.1_step3_completion_summary.md)** to understand current state

2. **Review [v0.2-overview.md](v0.2-overview.md)** phases 0.2.3-0.2.5 for context

3. **Decide Step 4 focus:**
   - Real data pipeline (most likely)
   - Diagnostics module
   - Sampler evaluation

4. **Check existing implementations:**
   - `gimbal/triangulation.py`, `data_cleaning.py`, `prior_building.py`
   - `examples/demo_v0_2_1_data_driven_priors.py` (shows the intended flow)

5. **Plan integration:**
   - Which dataset? (AIST++ is mentioned in v0.2-overview.md)
   - End-to-end test structure
   - Success criteria

## üìã Quick Command Reference

```bash
# Generate synthetic datasets
pixi run generate-datasets v0.2.1_L00_minimal v0.2.1_L01_noise

# Run Step 3 tests
pixi run test-pipeline

# Run data-driven priors demo
pixi run python examples/demo_v0_2_1_data_driven_priors.py

# Launch JupyterLab
pixi run notebook
```

## üîó See Also

- [README.md](README.md) - Plans directory organization
- [v0.1-overview.md](v0.1-overview.md) - Three-stage HMM architecture
- [REPOSITORY_CLEANUP_COMPLETE.md](REPOSITORY_CLEANUP_COMPLETE.md) - v0.2.0 cleanup summary
