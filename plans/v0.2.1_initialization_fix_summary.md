# v0.2.1 Initialization Fix Summary

**Date:** December 20, 2025  
**Goal:** Fix -inf log-probability initialization failures by hardening skeletal parameter estimation and routing all tests through library estimator.

## Problem Diagnosis

Initial diagnostic tests (Group 1 & 2, run_id: `local_run`) revealed:

- **Total logp at init:** `-inf` (infinite negative)
- **Root cause:** Three variables had `-∞` log-probability:
  - `rho` (bone lengths)
  - `sigma2` (bone variances)
  - `length_1` (per-frame bone lengths)
- **Consequence:** 1,802 NaN gradients (6.7%), NUTS unable to take any valid steps → 100% divergences

## Root Cause Analysis

Ad-hoc initialization in test files was:
1. Using random 3D positions (`np.random.randn(T, K, 3) * 10 + 100`)
2. Computing bone lengths from Stage D cleaned 3D without validation
3. Setting `sigma2 = rho * 0.01` without checking positivity
4. **No validation** that initialization satisfied model constraints

Result: Values violated hard positivity constraints on Gamma priors → `-inf` logp.

## Solution Implemented

### 1. Hardened Library Estimator (`gimbal/fit_params.py`)

**Function:** `_estimate_skeletal_parameters_numpy()`

**Robust estimation:**
- Uses **median** for location (not mean)
- Uses **MAD → SD** for dispersion (not variance)
- Strict minimum sample requirements:
  - Absolute: 10 frames minimum
  - Relative: 5% of total frames
  - Both positions finite AND length > `eps_length` (1e-6)

**Strict validation:**
- `rho_floor = 0.001` (1mm absolute minimum)
- `sigma2_floor = max(1e-6, (0.01 * rho)^2)` (1% relative + absolute)
- Raises `ValueError` with bone-specific diagnostics if:
  - Insufficient valid samples
  - Non-finite estimates
  - Values below floors

**Error messages include:**
- Bone index and parent index
- Number of valid samples vs. required
- Length range for debugging
- Actionable suggestions (check triangulation, increase visibility)

### 2. Validation Gate in Model Builder (`gimbal/pymc_model.py`)

**Location:** Before `with model:` context (lines ~460-515)

**Validates init_result before model construction:**
- `rho_init`: all finite, all > 0.001
- `sigma2_init`: all finite, all > 1e-6
- Array lengths match skeleton (K-1)

**Benefits:**
- Fails **immediately** with clear error (not during sampling)
- Identifies specific bones with issues
- References validation floors from estimator

### 3. Routed Tests Through Library

**Updated files:**
- `tests/diagnostics/v0_2_1_divergence/test_group_1_build_only_sanity.py`
- `tests/diagnostics/v0_2_1_divergence/test_group_2_gradient_sanity.py`
- `tests/pipeline/stage_g_model_build.py`
- `tests/pipeline/stage_h_fitting.py`

**Changes:**
```python
# OLD: Ad-hoc initialization
x_init = np.random.randn(T, K, 3) * 10 + 100
rho_init = data["bone_lengths"][:K-1]
init_result = InitializationResult(x_init, ..., rho=rho_init, sigma2=rho_init*0.01, ...)

# NEW: Library estimator
from gimbal.fit_params import initialize_from_observations_dlt
init_result = initialize_from_observations_dlt(
    y_observed=data["y_2d"],
    camera_proj=data["camera_proj"],
    parents=data["parents"],
)
```

**Key invariant enforced:** `parents` array used in estimator is **exactly** the same as passed to model builder.

## Results

### Before Fix (run_id: `local_run`)

**Group 1: Build-Only Sanity**
- Total logp: **-inf**
- Has Inf: **True**
- Worst terms: `rho`, `sigma2`, `length_1` all `-∞`

**Group 2: Gradient Sanity**
- Gradient L2 norm: **NaN**
- NaN count: **1,802 / 27,025** (6.7%)
- All perturbations: **-inf** logp, non-finite gradients

**Stage H Sampling**
- Divergences: **400 / 400** (100%)
- R-hat max: **26,835,525**
- ESS min: **2**

### After Fix (run_id: `lib_init_fix`)

**Group 1: Build-Only Sanity** ✓ PASSED
- Total logp: **-251,431.79** (finite!)
- Has Inf: **False**
- Has NaN: **False**
- Worst terms: `y_obs` (-124,220), `raw_u_*` (~-5,862) - all finite
- Bone lengths: `[9.999, 8.002, 7.999]` - reasonable scale
- Bone variances: `[0.010, 0.006, 0.006]` - 1% order of magnitude

**Group 2: Gradient Sanity** ✓ PASSED
- Gradient L2 norm: **1.54e+08** (large but finite)
- Gradient L-inf norm: **8.95e+07**
- NaN count: **0 / 27,025** (0%)
- Inf count: **0 / 27,025** (0%)
- All perturbations: **finite** logp and gradients

**Stage H Sampling** (still fails, but differently)
- Initialization: **Succeeds** (finite logp)
- Divergences: **400 / 400** (100% - unchanged)
- R-hat max: **26,835,525** (unchanged)
- ESS min: **2** (unchanged)
- **Interpretation:** Initialization issue **fixed**, but sampling geometry issues remain (separate problem)

## Improvement Summary

| Metric | Before | After | Status |
|--------|--------|-------|--------|
| **Logp at init** | -inf | -251,432 | ✓ Fixed |
| **NaN gradients** | 1,802 | 0 | ✓ Fixed |
| **Inf check** | True | False | ✓ Fixed |
| **rho validity** | -inf | [10.0, 8.0, 8.0] | ✓ Fixed |
| **sigma2 validity** | -inf | [0.010, 0.006, 0.006] | ✓ Fixed |
| **Divergences** | 400 | 400 | ⚠ Unchanged |
| **R-hat max** | 26.8M | 26.8M | ⚠ Unchanged |

## Next Steps (Future Work)

The initialization is now correct, but sampling still fails. Remaining issues are **geometry/parameterization** problems:

### Priority 1: Gradient Magnitude Analysis
- L-inf norm ~90M is extremely large
- Top gradients are in `dir_hmm_mu_raw` (up to 89M!)
- Suggests poor conditioning or scale mismatch in HMM prior

### Priority 2: Reparameterization Candidates
- **Non-centered parameterization** for hierarchical terms
- **Direction HMM:** Consider alternative to raw Gaussian + normalize
- **Observation likelihood:** Check if 124k logp is appropriate scale

### Priority 3: Alternative Samplers
- Try **nutpie** (specialized for high-dim)
- Increase `target_accept` to 0.95+ (more cautious steps)
- Consider ADVI initialization before NUTS

### Priority 4: Model Simplification
- Test without directional HMM (remove Stage 3)
- Test with simple Gaussian observation (no mixture)
- Reduce T to 100 frames (isolate temporal vs. joint issues)

## Files Modified

**Library (gimbal/):**
- `gimbal/fit_params.py` (131 lines changed)
  - `_estimate_skeletal_parameters_numpy()`: Robust estimation + validation
  - `initialize_from_observations_dlt()`: Error wrapping
- `gimbal/pymc_model.py` (60 lines added)
  - Validation gate before model construction

**Tests (tests/):**
- `tests/diagnostics/v0_2_1_divergence/test_group_1_build_only_sanity.py`
- `tests/diagnostics/v0_2_1_divergence/test_group_2_gradient_sanity.py`
- `tests/pipeline/stage_g_model_build.py`
- `tests/pipeline/stage_h_fitting.py`

**All test changes:** Replaced ad-hoc `InitializationResult` construction with `initialize_from_observations_dlt()`.

## Validation Commands

```powershell
# Diagnostic tests
pixi run python tests\diagnostics\v0_2_1_divergence\test_group_1_build_only_sanity.py --run_id lib_init_fix
pixi run python tests\diagnostics\v0_2_1_divergence\test_group_2_gradient_sanity.py --run_id lib_init_fix

# Pipeline test
pixi run python tests\pipeline\stage_h_fitting.py
```

## Conclusion

✓ **Initialization problem completely solved**
- No more -inf log-probabilities
- No more NaN gradients
- All constraints satisfied at initial point

⚠ **Sampling problem remains**
- 100% divergence rate unchanged
- This is a **separate issue** (geometry/conditioning, not initialization)
- Documented gradient magnitude issues point to specific parameterization problems

**The model now builds correctly and starts from a valid point. Sampling failures are due to posterior geometry, not broken initialization.**
