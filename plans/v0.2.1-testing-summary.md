GIMBAL v0.2.1 Divergence Testing Summary

Purpose
The goal of this testing plan is to identify the causes of NUTS divergences in the v0.2.1 GIMBAL model and to empirically separate contributions from:

The base camera + kinematic model (no HMM)

The directional HMM

The number of HMM states

Scale imbalance between likelihood components

Known hierarchical funnels (root temporal variance, bone-length variance)

Runtime scaling issues in the collapsed HMM

This document defines all tests that must be run and logged before we make structural changes to the model.

Synthetic Data Configuration
All tests use the same synthetic dataset:
T = 100
C = 3
S = 3 (except state-count tests)
kappa = 10.0
obs_noise_std = 0.5
occlusion_rate = 0.02
random_seed = 42

Test Group 1 — Baseline model without HMM
Run the full model with use_directional_hmm=False.
Record:

Divergence count

ESS for x_all, U, obs_sigma

R-hat

Reconstruction error for x_all mean vs x_true

Runtime

Purpose:
Determines whether divergences originate in the camera/kinematic model alone.

Test Group 2 — Baseline model with HMM
Same configuration as Test Group 1 except use_directional_hmm=True and hmm_num_states=3.
Record all metrics from Group 1 plus:

Magnitude of hmm_loglik

Magnitude of camera log likelihood

Likelihood ratio

Purpose:
Assesses the added effect of the directional HMM.

Test Group 3 — State count comparison
Run models with:
S = 1
S = 2
S = 3
For S=1 ensure the specialized code path is triggered.

Record:

Divergence counts

ESS

R-hat

Reconstruction error

Purpose:
Determines whether multi-state dynamics worsen posterior geometry.

Test Group 4 — Likelihood scale balance
For all models in Groups 1–3 compute:

mean absolute hmm_loglik

mean absolute log_obs_t.sum()

ratio = |hmm| / |camera|

Mark test as “imbalanced” if ratio > 3 or < 1/3.

Purpose:
Checks for mis-scaled likelihood components driving divergences.

Test Group 5 — Divergence localization
For each test run ArviZ diagnostics:

parallel plot

pair plot with divergences
Save output under:
tests/v0.2.1-diagnostics/<testname>/

Purpose:
Identify which parameters participate in divergent transitions.

Test Group 6 — Root temporal variance sensitivity
Repeat Tests 1 and 2 with:

eta2_root_sigma = 5.0

eta2_root_sigma = 10.0
Record divergence changes.

Purpose:
Evaluates whether the root random walk creates a hierarchical funnel.

Test Group 7 — Bone-length variance sensitivity
Repeat Test Group 1 under:

sigma2_sigma = 1.0

sigma2_sigma = 5.0

Fix sigma2 to initval
Record divergence changes.

Purpose:
Evaluates whether bone-length variance contributes to divergences.

Test Group 8 — Runtime scaling
Run both HMM-off and HMM-on models for:

T = 30

T = 60

T = 100
and for:

S = 1

S = 2

S = 3
Record runtime and divergences.

Purpose:
Verify that the collapsed HMM scales correctly and does not shortcut gradients.

Reporting Requirements
For each test produce:

Model configuration

Divergence count

ESS

R-hat

Runtime

Reconstruction error

Likelihood magnitudes

Notes and interpretation

All results must be saved into:
tests/v0.2.1-divergence-report.md