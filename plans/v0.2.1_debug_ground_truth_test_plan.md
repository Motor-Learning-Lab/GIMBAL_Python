# Ground Truth Initialization Test Plan

**Date**: 2025-12-07  
**Purpose**: Diagnose model initialization failures by testing with ground truth starting values

---

## Problem Statement

The v0.2.1 divergence tests are failing at model initialization with:
- `inlier_prob_logodds__: inf` 
- `inlier_prob: -inf` log probability
- This prevents any sampling from occurring

## Hypothesis

If we initialize the model with the exact ground truth parameters (no noise/jitter), we should be able to:
1. **Pass initial evaluation** - the model should accept its own generating parameters
2. **Sample successfully** - if initialization is the only issue
3. **Identify the bug** - if even ground truth fails, there's a deeper issue

## Test Design

### Test Configuration
- **Synthetic data**: Generate with known ground truth parameters
- **Model initialization**: Use exact ground truth as starting point
- **No jitter**: Disable PyMC's initialization jitter
- **Minimal complexity**: Start with simplest case (T=50, S=2, K=3)

### Ground Truth Parameters to Test
1. **Skeleton parameters**: `x_root`, `rho`, `sigma2`, `eta2_root`, bone vectors `u`
2. **Bone lengths**: `length_*` (match synthetic data exactly)
3. **Observation noise**: `obs_sigma` (match data generation)
4. **Outlier model**: `inlier_prob_logodds` (this is the suspect)
5. **HMM parameters**: `dir_hmm_mu_raw`, `dir_hmm_kappa`, transition/init logits

### Execution Steps

1. **Generate synthetic data** with known parameters
2. **Create model** with v0.2.1 pipeline
3. **Set starting point** to exact ground truth (transformed to unconstrained space)
4. **Check initial log probability**
   - If finite: initialization bug is in jitter/default values
   - If -inf: bug is in model specification or transformation
5. **Attempt sampling** with 10 draws
   - If succeeds: confirms initialization is the only issue
   - If fails: identifies where the problem occurs

### Expected Outcomes

| Scenario | Initial logp | Sampling | Interpretation |
|----------|-------------|----------|----------------|
| Success | Finite | ✓ | Initialization jitter is the problem |
| Partial | Finite | ✗ | Model has sampling issues beyond initialization |
| Failure | -inf | N/A | Bug in model specification or parameter transformation |

### Output Location

- **Test script**: `tests/diagnostics/v0_2_1_divergence/test_ground_truth_init.py`
- **Results**: `results/diagnostics/v0_2_1_divergence/ground_truth_init/`
  - `test_output.txt` - console output with logp values
  - `initial_point.json` - ground truth starting point
  - `trace_summary.txt` - if sampling succeeds
- **Report**: `results/diagnostics/v0_2_1_divergence/ground_truth_init_report.md`

---

## Implementation Notes

### Key Technical Details

1. **Unconstrained transformation**: PyMC samples in unconstrained space
   - `obs_sigma_log__` not `obs_sigma`
   - `inlier_prob_logodds__` not `inlier_prob`
   - Need to transform ground truth appropriately

2. **Critical parameter**: `inlier_prob_logodds`
   - Currently appearing as `inf` in failed tests
   - Need to verify:
     - Is it specified in the model?
     - Is the prior well-defined?
     - Is the transformation correct?

3. **Data generation**: Use `synthetic_data.py`
   - Ensure all parameters are captured
   - Match exact configuration used in model

### Success Criteria

- [ ] Test runs without exceptions
- [ ] Initial log probability is finite
- [ ] Can identify which parameter causes -inf if it occurs
- [ ] Clear documentation of findings

---

## Next Steps After Test

Based on results:
1. **If initialization works**: Fix the jitter/default initialization in main tests
2. **If specific parameter fails**: Debug that parameter's prior/transformation
3. **If model structure fails**: Review model specification in `pymc_model.py`
