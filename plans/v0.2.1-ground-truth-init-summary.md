# Ground Truth Initialization Test - Summary

**Date**: 2025-12-07  
**Test Location**: `tests/diagnostics/v0_2_1_divergence/test_ground_truth_init.py`  
**Results Location**: `results/diagnostics/v0_2_1_divergence/ground_truth_init/`

---

## Executive Summary

**Finding**: The GIMBAL v0.2.1 model produces **-inf log probability** even with PyMC's default initialization strategy. This is a fundamental model bug, not an initialization or jitter issue.

---

## Test Design

### Approach
1. Generate synthetic data with known parameters (T=50, S=2, K=6, C=4)
2. Build PyMC model using standard `build_test_model()` function
3. Check if model can compute finite log probability with default initialization
4. Diagnose which parameter causes -inf if initialization fails

### Ground Truth Parameters Used
- `obs_sigma = 0.5` → `obs_sigma_log__ = -0.693`
- `inlier_prob = 0.95` (occlusion_rate = 0.05) → `inlier_prob_logodds__ = 2.944`
- Joint positions from synthetic data
- All parameters within valid ranges

---

## Results

### Model Structure
The model has **42 free random variables**:
- Skeleton structure (14 params): `eta2_root`, `rho`, `sigma2`, `x_root`, `raw_u_1` through `raw_u_5`, `length_1` through `length_5`
- Observation model (2 params): `obs_sigma`, `inlier_prob`
- HMM parameters (26 params): directional means, concentrations, init/transition logits

### Key Finding
```
Default initialization log probability: -inf
```

**Status**: ❌ **FAILED**

The model **cannot evaluate a finite log probability** even with PyMC's default initialization, which should provide reasonable starting values for all parameters.

### Attempted Diagnosis
Tried to identify which specific parameter causes -inf by computing per-parameter log probabilities, but encountered a technical error in the diagnostic code.

---

## Interpretation

### What This Means

1. **Not an initialization jitter problem**: The issue occurs even with PyMC's default init strategy
2. **Not a ground truth problem**: Our ground truth parameters are valid (inlier_prob=0.95, obs_sigma=0.5)
3. **Model specification bug**: There is likely:
   - An incorrectly specified prior
   - A missing constraint on a parameter
   - A transformation error (log/logit)
   - An incompatibility between parameter values

### Most Likely Culprits

Based on the divergence test failures showing `inlier_prob_logodds__: inf`, the suspect parameters are:

1. **`inlier_prob`** / **`inlier_prob_logodds__`**
   - Shows up as `inf` in failed tests
   - Logit transformation: `logodds = log(p / (1-p))`
   - If p=0 or p=1, logodds becomes +/-inf
   - **Hypothesis**: Prior or initialization might be putting prob at boundary

2. **Other log-transformed parameters**
   - `obs_sigma_log__`, `eta2_root_log__`, `rho_log__`, `sigma2_log__`
   - If any of these get initialized at or near 0, log gives -inf

3. **HMM concentration parameters**
   - `dir_hmm_kappa_*` - must be positive
   - If prior allows values ≤ 0, log probability becomes -inf

---

## Next Steps

### Immediate Actions

1. **Debug per-parameter log probabilities**
   - Fix the technical error in diagnostic code
   - Identify exactly which parameter(s) cause -inf
   - Check their default initialization values

2. **Review `inlier_prob` specification**
   - Check prior in `pymc_model.py` or `pymc_utils.py`
   - Verify logit transformation is correct
   - Ensure prior doesn't put mass at p=0 or p=1

3. **Review all priors**
   - Check that positivity constraints are enforced
   - Verify no priors have support that includes invalid values
   - Test each prior in isolation

### Code Locations to Check

- `gimbal/pymc_model.py` - Model construction
- `gimbal/pymc_utils.py` - Prior specifications
- `gimbal/fit_params.py` - Parameter fitting utilities
- `tests/diagnostics/v0_2_1_divergence/test_utils.py` - `build_test_model()` function

### Recommended Fix Strategy

1. Add explicit bounds/constraints to prevent parameters from hitting boundaries
2. Use more informative priors that keep parameters away from problematic regions
3. Add validation checks in model building to catch invalid parameter combinations
4. Consider using different transformations (e.g., `pm.Bound` for parameters near boundaries)

---

## Conclusion

The v0.2.1 divergence test failures are caused by a **fundamental model specification bug**, not initialization problems. The model produces -inf log probability even with default parameter values, indicating:

- **Incorrectly specified prior(s)**
- **Missing constraint(s)** on parameter ranges
- **Transformation error(s)** in parameter space

The most likely culprit is the `inlier_prob` parameter and its logit transformation, as this consistently appears as `inf` in test failures.

**Recommendation**: Focus debugging efforts on identifying which parameter(s) cause -inf log probability, starting with `inlier_prob_logodds__` and other log-transformed parameters.

---

## Files Generated

- `results/diagnostics/v0_2_1_divergence/ground_truth_init/test_output.txt` - Full console output
- `results/diagnostics/v0_2_1_divergence/ground_truth_init/initial_point.json` - Ground truth parameters
- `results/diagnostics/v0_2_1_divergence/ground_truth_init/ground_truth_init_report.md` - Detailed report
- `plans/v0.2.1-ground-truth-init-test.md` - Test plan
- `plans/v0.2.1-ground-truth-init-summary.md` - This summary
