# Debugging Plan: Model Building Without HMM

**Issue:** PyTensor gradient compilation fails when building GIMBAL model with `use_directional_hmm=False`

**Error:** KeyboardInterrupt during shape inference in PyTensor's graph compilation, suggesting infinite recursion or extremely long computation

**Date:** December 10, 2025

---

## Hypothesis

The model structure without HMM may have:
1. **Incompatible parameter shapes** that confuse PyTensor's shape inference
2. **Missing parameter specifications** that cause undefined gradients
3. **Circular dependencies** in the computation graph
4. **Incompatible transformations** when HMM-specific parameters are absent

---

## Debugging Steps

### Step 1: Verify synthetic data generation
**File:** `debug_step_1_verify_data.py`
**Purpose:** Ensure synthetic data is correctly formatted
**Checks:**
- Data shapes are correct (T, C, number of joints)
- No NaN or inf values
- Camera matrices are valid
- Observations are in valid range

**Expected outcome:** Data generation works correctly
**If fails:** Fix data generation before proceeding

---

### Step 2: Test model building in isolation
**File:** `debug_step_2_build_model.py`
**Purpose:** Build model without sampling to isolate compilation issue
**Checks:**
- Model builds without error
- All random variables are created
- Check free_RVs count matches expectations
- Inspect model structure

**Expected outcome:** Model builds successfully
**If fails:** Issue is in model specification, not sampling

---

### Step 3: Test initialization
**File:** `debug_step_3_test_initialization.py`
**Purpose:** Check if initialization values are valid
**Checks:**
- Get default test point from PyMC
- Evaluate log probability at test point
- Check for inf/-inf in initial logp
- Verify all parameters have finite values

**Expected outcome:** Initial point has finite log probability
**If fails:** Initialization issue (like the inlier_prob bug we fixed)

---

### Step 4: Test gradient computation manually
**File:** `debug_step_4_test_gradients.py`
**Purpose:** Manually compile gradient function to find where it fails
**Checks:**
- Try compiling logp function only (no gradients)
- Try compiling gradients one variable at a time
- Identify which variable causes gradient failure
- Check for circular dependencies

**Expected outcome:** Identify specific parameter causing gradient failure
**If fails:** Provides exact location of the issue

---

### Step 5: Compare HMM ON vs HMM OFF model structure
**File:** `debug_step_5_compare_models.py`
**Purpose:** See what differs between working (HMM ON) and broken (HMM OFF) models
**Checks:**
- List all random variables in each model
- Compare parameter counts
- Check for missing priors when HMM is OFF
- Identify structural differences

**Expected outcome:** Find missing or incompatible components when HMM is OFF
**If fails:** Models are identically structured (unlikely)

---

### Step 6: Test with minimal configuration
**File:** `debug_step_6_minimal_test.py`
**Purpose:** Reduce problem size to find minimum failing case
**Checks:**
- Try T=10 instead of T=100
- Try C=2 instead of C=3
- Try simpler prior specifications
- Disable mixture model if possible

**Expected outcome:** Find if complexity is the issue
**If fails:** Issue is fundamental to model structure

---

### Step 7: Test PyMC/PyTensor versions
**File:** `debug_step_7_check_environment.py`
**Purpose:** Verify environment is correct
**Checks:**
- PyMC version
- PyTensor version
- Known compatibility issues
- Test simple PyMC model without GIMBAL

**Expected outcome:** Environment is correctly configured
**If fails:** May need to update dependencies

---

### Step 8: Review build_camera_observation_model code
**File:** `debug_step_8_review_model_code.py`
**Purpose:** Check if model building code has issues when HMM OFF
**Checks:**
- Read gimbal.pymc_model.build_camera_observation_model source
- Look for conditional logic based on use_directional_hmm
- Check if some parameters are only defined when HMM is ON
- Verify all code paths are valid

**Expected outcome:** Find conditional code that breaks when HMM OFF
**If fails:** Code review by human needed

---

## Success Criteria

Debug process is successful when:
1. Model builds without error when `use_directional_hmm=False`
2. Gradient compilation completes in reasonable time (<1 minute)
3. Initial log probability is finite
4. Can successfully sample from the model

---

## Directory Structure

```
tests/diagnostics/v0_2_1_divergence_debug_no_hmm/
├── debug_step_1_verify_data.py
├── debug_step_2_build_model.py
├── debug_step_3_test_initialization.py
├── debug_step_4_test_gradients.py
├── debug_step_5_compare_models.py
├── debug_step_6_minimal_test.py
├── debug_step_7_check_environment.py
├── debug_step_8_review_model_code.py
├── results_step_1_verify_data.json
├── results_step_2_build_model.json
├── results_step_3_test_initialization.json
├── results_step_4_test_gradients.json
├── results_step_5_compare_models.json
├── results_step_6_minimal_test.json
├── results_step_7_check_environment.json
├── results_step_8_review_model_code.json
├── report_step_1_verify_data.md
├── report_step_2_build_model.md
├── ... (one report per step)
└── report_summary.md
```

---

## Notes

- Each step should be run independently
- Stop after first failure and analyze before proceeding
- Document all findings in step reports
- Update this plan if new hypotheses emerge
